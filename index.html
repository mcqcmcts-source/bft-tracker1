<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Military BFT Tracker</title>
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1pbGl0YXJ5IEJGVCBUcmFja2VyIiwKICAic2hvcnRfbmFtZSI6ICJCRlQgVHJhY2tlciIsCiAgImRlc2NyaXB0aW9uIjogIkJhc2ljIEZpdG5lc3MgVGVzdCBQZXJmb3JtYW5jZSBNYW5hZ2VtZW50IFN5c3RlbSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMWIwZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0YWRlODAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY2lJSGRwWkhSb1BTSXhNakFpSUdobGFXZG9kRDBpTVRJd0lqNDhjbVZqZENCM2FXUjBhRDBpTVRJd0lpQm9aV2xuYUhROUlqRXlNQ0lpSUdacGJHdzlJaU0wWVdSbE9EQWlMejQ4ZEdWNGRDQjRQU0kyTUNJZ2VUMGlOVEFpSUdacGJHdzlJaU0zTm1WbU9UZ2lJR1p2Ym5RdGMybDZaVDBpTWpBaUlIUmxlSFF0WVc1amFHOXlQU0p0YVdSa2JHVWlQa0pHVkR3dmRHVjRkRDQ4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMTIweDEyMCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
    <!-- Your existing styles (unchanged, truncated for brevity) -->
    <style>
        /* ... All your existing CSS ... */
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- ... Your existing HTML content ... -->
        <!-- Login Screen -->
        <div id="loginScreen" class="mobile-content">
            <div class="mobile-card">
                <h2>üîê Access BFT Tracker</h2>
                <div id="loginForm">
                    <div class="form-group">
                        <label>Service Number</label>
                        <input type="text" id="loginServiceNumber" placeholder="Enter your Service Number" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                    </div>
                    <button class="mobile-btn success full-width" onclick="login()">üîì Sign In</button>
                    <div style="text-align: center; margin: 20px 0; color: #86efac; font-size: 0.9rem;">
                        Don't have an account?
                    </div>
                    <button class="mobile-btn secondary full-width" onclick="showSignup()">üìù Create Account</button>
                </div>
                <div id="signupForm" style="display: none;">
                    <div class="form-group">
                        <label>Service Number</label>
                        <input type="text" id="signupServiceNumber" placeholder="Enter your Service Number" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label>Create Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a secure password" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="signupName" placeholder="Enter your full name" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label>Rank</label>
                        <input type="text" id="signupRank" placeholder="Enter your rank" autocomplete="organization-title">
                    </div>
                    <div class="form-group">
                        <label>Unit</label>
                        <input type="text" id="signupUnit" placeholder="Enter your unit" autocomplete="organization">
                    </div>
                    <button class="mobile-btn success full-width" onclick="signup()">‚úÖ Create Account</button>
                    <div style="text-align: center; margin: 20px 0; color: #86efac; font-size: 0.9rem;">
                        Already have an account?
                    </div>
                    <button class="mobile-btn secondary full-width" onclick="showLogin()">üîì Sign In</button>
                </div>
                <!-- ... Security Notice ... -->
            </div>
        </div>
        <!-- Main App Content -->
        <!-- ... All your existing tracker UI ... -->
    </div>
    <!-- ... Footer and other components ... -->

    <!-- Firebase Integration JavaScript -->
    <script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyDfKp7_rwvjMvdOk_h0816acG81Wg-antw",
        authDomain: "mcts-bft-tracker.firebaseapp.com",
        projectId: "mcts-bft-tracker",
        storageBucket: "mcts-bft-tracker.appspot.com",
        messagingSenderId: "380904216735",
        appId: "1:380904216735:web:4e2dce375c1c74718ebaaa",
        measurementId: "G-GTEQ346JMB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- AUTH FUNCTIONS ---
    function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
    }
    function showSignup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
    }
    function signup() {
        const serviceNumber = document.getElementById('signupServiceNumber').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        const name = document.getElementById('signupName').value.trim();
        const rank = document.getElementById('signupRank').value.trim();
        const unit = document.getElementById('signupUnit').value.trim();
        if (!serviceNumber || !password || !confirm || !name) {
            showToast('Please fill all required fields', 'error'); return;
        }
        if (password !== confirm) {
            showToast('Passwords do not match', 'error'); return;
        }
        const email = serviceNumber + '@bft.com';
        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                // Save profile to Firestore
                db.collection('profiles').doc(userCredential.user.uid).set({
                    serviceNumber, name, rank, unit, timestamp: Date.now()
                });
                showToast('Account created & logged in!', 'success');
                showMainApp();
            })
            .catch(e => showToast(e.message, 'error'));
    }
    function login() {
        const serviceNumber = document.getElementById('loginServiceNumber').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!serviceNumber || !password) {
            showToast('Enter service number and password', 'error'); return;
        }
        const email = serviceNumber + '@bft.com';
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                showToast('Welcome!', 'success');
                showMainApp();
            })
            .catch(e => showToast(e.message, 'error'));
    }
    function logout() {
        auth.signOut().then(() => {
            showToast('Signed out!', 'success');
            showLoginScreen();
        });
    }
    auth.onAuthStateChanged(function(user) {
        if (user) {
            showMainApp();
            loadUserData(user.uid);
        } else {
            showLoginScreen();
        }
    });

    // --- PROFILE & RECORDS FUNCTIONS ---
    function saveProfile() {
        const user = auth.currentUser;
        if (!user) return;
        const serviceNumber = document.getElementById('serviceNumber').value;
        const rank = document.getElementById('rank').value;
        const name = document.getElementById('name').value;
        const unit = document.getElementById('unit').value;
        let photo = "";
        const previewImage = document.getElementById('previewImage');
        if (previewImage && previewImage.src && previewImage.src !== window.location.href) photo = previewImage.src;
        db.collection('profiles').doc(user.uid).set({
            serviceNumber, rank, name, unit, photo, timestamp: Date.now()
        }).then(() => {
            showToast('Profile saved!', 'success');
            displayProfile();
        });
    }
    function displayProfile() {
        const user = auth.currentUser;
        if (!user) return;
        db.collection('profiles').doc(user.uid).get().then(doc => {
            if (doc.exists) {
                const profile = doc.data();
                // Populate your UI as before
                document.getElementById('serviceNumber').value = profile.serviceNumber || '';
                document.getElementById('rank').value = profile.rank || '';
                document.getElementById('name').value = profile.name || '';
                document.getElementById('unit').value = profile.unit || '';
                if (profile.photo) {
                    document.getElementById('profilePhotoDisplay').style.display = 'block';
                    document.getElementById('displayPhoto').src = profile.photo;
                    document.getElementById('previewImage').src = profile.photo;
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('noPhotoPlaceholder').style.display = 'none';
                } else {
                    document.getElementById('profilePhotoDisplay').style.display = 'none';
                    document.getElementById('photoPreview').style.display = 'none';
                    document.getElementById('noPhotoPlaceholder').style.display = 'flex';
                }
            }
        });
    }

    // --- TEST RECORDS ---
    function addTestRecord() {
        const user = auth.currentUser;
        if (!user) return;
        const testDate = document.getElementById('testDate').value;
        const ageAtTest = parseInt(document.getElementById('ageAtTest').value);
        const pushUps = parseInt(document.getElementById('pushUps').value);
        const sitUps = parseInt(document.getElementById('sitUps').value);
        const runMinutes = parseInt(document.getElementById('runMinutes').value);
        const runSeconds = parseInt(document.getElementById('runSeconds').value);
        // You may want to use your existing evaluateTest logic here
        const record = {
            testDate, ageAtTest, pushUps, sitUps, runMinutes, runSeconds,
            timestamp: Date.now(), userUid: user.uid
        };
        db.collection('records').add(record)
            .then(() => {
                showToast('Test record added!', 'success');
                displayRecords();
            });
    }
    function displayRecords() {
        const user = auth.currentUser;
        if (!user) return;
        db.collection('records').where('userUid', '==', user.uid).get()
            .then(snapshot => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Render your records in the UI as before
                // (Replace your IndexedDB records rendering with this array)
            });
    }

    // --- SUPPORTING FUNCTIONS ---
    function showMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        displayProfile();
        displayRecords();
    }
    function showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
        showLogin();
    }
    function showToast(message, type='info') {
        // ... your toast logic ...
        alert(message); // replace with your toast UI
    }

    // --- PHOTO HANDLING (unchanged) ---
    function handlePhotoUpload() {
        const fileInput = document.getElementById('profilePhoto');
        const file = fileInput.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('Photo size must be less than 5MB');
                fileInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('photoPreview');
                const previewImage = document.getElementById('previewImage');
                const placeholder = document.getElementById('noPhotoPlaceholder');
                previewImage.src = e.target.result;
                photoPreview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }
    function removePhoto() {
        document.getElementById('profilePhoto').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('noPhotoPlaceholder').style.display = 'flex';
        document.getElementById('previewImage').src = '';
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', function() {
        showLoginScreen();
    });
    </script>
</body>
</html>
