<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Military BFT Tracker</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paste ALL your original CSS here (already in your file) */
        /* ... (unchanged, see your Index.txt) ... */
    </style>
</head>
<body>
    <!-- Paste ALL your original HTML (unchanged) here -->
    <!-- ... (already in your Index.txt) ... -->

    <script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDfKp7_rwvjMvdOk_h0816acG81Wg-antw",
        authDomain: "mcts-bft-tracker.firebaseapp.com",
        projectId: "mcts-bft-tracker",
        storageBucket: "mcts-bft-tracker.appspot.com",
        messagingSenderId: "380904216735",
        appId: "1:380904216735:web:4e2dce375c1c74718ebaaa",
        measurementId: "G-GTEQ346JMB"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Replace IndexedDB logic: use Firebase Auth + Firestore

    // --- AUTH ---
    function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
        clearAuthForms();
    }
    function showSignup() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
        clearAuthForms();
    }
    function clearAuthForms() {
        document.getElementById('loginServiceNumber').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('signupServiceNumber').value = '';
        document.getElementById('signupPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('signupName').value = '';
        document.getElementById('signupRank').value = '';
        document.getElementById('signupUnit').value = '';
    }
    function signup() {
        const serviceNumber = document.getElementById('signupServiceNumber').value.trim();
        const password = document.getElementById('signupPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        const name = document.getElementById('signupName').value.trim();
        const rank = document.getElementById('signupRank').value.trim();
        const unit = document.getElementById('signupUnit').value.trim();
        if (!serviceNumber || !password || !confirm || !name) {
            showToast('Please fill all required fields', 'error'); return;
        }
        if (password !== confirm) {
            showToast('Passwords do not match', 'error'); return;
        }
        const email = serviceNumber + '@bft.com';
        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                db.collection('profiles').doc(userCredential.user.uid).set({
                    serviceNumber, name, rank, unit, timestamp: Date.now()
                });
                showToast('Account created & logged in!', 'success');
                showMainApp();
            })
            .catch(e => showToast(e.message, 'error'));
    }
    function login() {
        const serviceNumber = document.getElementById('loginServiceNumber').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!serviceNumber || !password) {
            showToast('Enter service number and password', 'error'); return;
        }
        const email = serviceNumber + '@bft.com';
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                showToast('Welcome!', 'success');
                showMainApp();
            })
            .catch(e => showToast(e.message, 'error'));
    }
    function logout() {
        auth.signOut().then(() => {
            showToast('Signed out!', 'success');
            showLoginScreen();
        });
    }
    auth.onAuthStateChanged(function(user) {
        if (user) {
            showMainApp();
            displayProfile();
            displayRecords();
        } else {
            showLoginScreen();
        }
    });

    // --- PROFILE & RECORDS ---
    function saveProfile() {
        const user = auth.currentUser;
        if (!user) return;
        const serviceNumber = document.getElementById('serviceNumber').value;
        const rank = document.getElementById('rank').value;
        const name = document.getElementById('name').value;
        const unit = document.getElementById('unit').value;
        let photo = "";
        const previewImage = document.getElementById('previewImage');
        if (previewImage && previewImage.src && previewImage.src !== window.location.href) photo = previewImage.src;
        db.collection('profiles').doc(user.uid).set({
            serviceNumber, rank, name, unit, photo, timestamp: Date.now()
        }).then(() => {
            showToast('Profile saved!', 'success');
            displayProfile();
        });
    }
    function displayProfile() {
        const user = auth.currentUser;
        if (!user) return;
        db.collection('profiles').doc(user.uid).get().then(doc => {
            if (doc.exists) {
                const profile = doc.data();
                document.getElementById('serviceNumber').value = profile.serviceNumber || '';
                document.getElementById('rank').value = profile.rank || '';
                document.getElementById('name').value = profile.name || '';
                document.getElementById('unit').value = profile.unit || '';
                if (profile.photo) {
                    document.getElementById('profilePhotoDisplay').style.display = 'block';
                    document.getElementById('displayPhoto').src = profile.photo;
                    document.getElementById('previewImage').src = profile.photo;
                    document.getElementById('photoPreview').style.display = 'block';
                    document.getElementById('noPhotoPlaceholder').style.display = 'none';
                } else {
                    document.getElementById('profilePhotoDisplay').style.display = 'none';
                    document.getElementById('photoPreview').style.display = 'none';
                    document.getElementById('noPhotoPlaceholder').style.display = 'flex';
                }
            }
        });
    }
    function addTestRecord() {
        const user = auth.currentUser;
        if (!user) return;
        const testDate = document.getElementById('testDate').value;
        const ageAtTest = parseInt(document.getElementById('ageAtTest').value);
        const pushUps = parseInt(document.getElementById('pushUps').value);
        const sitUps = parseInt(document.getElementById('sitUps').value);
        const runMinutes = parseInt(document.getElementById('runMinutes').value);
        const runSeconds = parseInt(document.getElementById('runSeconds').value);
        // For score calculations, paste your evaluateTest logic here if needed
        const record = {
            testDate, ageAtTest, pushUps, sitUps, runMinutes, runSeconds,
            timestamp: Date.now(), userUid: user.uid
        };
        db.collection('records').add(record)
            .then(() => {
                showToast('Test record added!', 'success');
                displayRecords();
            });
    }
    function displayRecords() {
        const user = auth.currentUser;
        if (!user) return;
        db.collection('records').where('userUid', '==', user.uid).get()
            .then(snapshot => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Render your records in the UI as before
                // (Replace your IndexedDB records rendering with this array)
            });
    }
    function showMainApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        displayProfile();
        displayRecords();
    }
    function showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('mainApp').style.display = 'none';
        showLogin();
    }
    function showToast(message, type='info') {
        // Replace with your toast UI or use alert for now
        alert(message);
    }
    function handlePhotoUpload() {
        const fileInput = document.getElementById('profilePhoto');
        const file = fileInput.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('Photo size must be less than 5MB');
                fileInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoPreview = document.getElementById('photoPreview');
                const previewImage = document.getElementById('previewImage');
                const placeholder = document.getElementById('noPhotoPlaceholder');
                previewImage.src = e.target.result;
                photoPreview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }
    function removePhoto() {
        document.getElementById('profilePhoto').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('noPhotoPlaceholder').style.display = 'flex';
        document.getElementById('previewImage').src = '';
    }
    document.addEventListener('DOMContentLoaded', function() {
        showLoginScreen();
    });
    </script>
</body>
</html>
